<!DOCTYPE html>
<html>
<head>
    <title>@Model.Title</title>
    <script type="text/javascript" src="/Scripts/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/Scripts/bootstrap.min.js"></script>
    <script type="text/javascript" src="/Scripts/highlight.pack.js"></script>
    <script type="text/javascript" src="/Scripts/handlebars.min.js"></script>
    <link rel="stylesheet" href="/Content/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="/Content/highlight/obsidian.css" />
    <link rel="stylesheet" href="/Content/screen.css" />
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="nav navbar-nav navbar-left navbar-props">
                    <a href="http://geteventstore.com/" target="_blank">
                        <img src="/Content/images/eventstore_logo.png" style="padding: 7px;" /></a>
                </div>
                <div class="nav navbar-nav navbar-right navbar-props">
                    <a href="http://nancyfx.org" target="_blank">
                        <img src="/Content/images/Nancy-logo.png" height="50" /></a>
                </div>
                <a class="navbar-brand col-sm-12" style="text-align: center;" href="/">@Model.Title</a>
            </div>
        </div>
    </nav>
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <div id="notifications"></div>
            <div class="jumbotron">
                <div class="container">
                    <h1>Code Blame!</h1>
                    <p>We all stumble across seriously bad code on a daily basis. This site is a vent for that.</p>
                    <p><a class="btn btn-primary btn-lg" id="new-blame">New Blame</a></p>
                </div>
            </div>
            <div id="new-blame-form" class="hidden panel panel-default">
                <div class="panel-heading">Blame</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label for="description" class="col-lg-2 control-label">Description</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="description" placeholder="Description">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="language" class="col-lg-2 control-label">Language</label>
                        <div class="col-lg-10">
                            <div class="btn-group">
                                <select class="form-control" id="language">
                                    @Each.Languages
                                    <option value="@Current.Key">@Current.Value</option>
                                    @EndEach
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="code" class="col-lg-2 control-label">Code</label>
                        <div class="col-lg-10">
                            <textarea id="code" class="form-control" placeholder="Code"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-offset-2 col-lg-10">
                            <button type="submit" class="btn btn-default" id="add-blame" >Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="blames">
            </div>
        </div>
    </div>
    <script id="blame-template" type="text/x-handlebars-template">
        <div class="panel panel-default">
            <div class="panel-heading">{{description}}</div>
            <div class="panel-body">
                <pre>
                    <code>{{code}}</code>
                </pre>
            </div>
        </div>
    </script>
    <script type="text/javascript">
        $(function () {
            $.ajax({
                type: 'GET',
                url: '/GetBlames',
                success: function (blames) {
                    for (var i = 0; i < blames.length; i++) {
                        var blame = {
                            description: blames[i].Description,
                            code: blames[i].Code
                        };
                        addBlame(blame, false);
                    }
                }
            });
            var source = $("#blame-template").html();
            var template = Handlebars.compile(source);
            hljs.initHighlightingOnLoad();
            $('#new-blame').click(function () {
                $('#new-blame-form').removeClass('hidden');
            });
            $('#add-blame').click(function() {
                var data = {
                    Description: $('#description').val(),
                    Language: $('#language').val(),
                    Code: $('#code').val()
                };
                $.ajax({
                    type: 'POST',
                    url: '/Add',
                    data: data,
                    success: function() {
                        var newBlame = {
                            description: $('#description').val(),
                            code: $('#code').val()
                        };
                        addBlame(newBlame, true);
                        clearBlameForm();
                    }
                });
            });
            var addBlame = function(blame, prepend) {
                var html = template(blame);
                var $html = $.parseHTML(html);
                if (prepend) {
                    $('#blames').prepend($html);
                } else {
                    $('#blames').append($html);
                }
                $('pre code', $html).each(function (i, e) { hljs.highlightBlock(e); });
            };
            var clearBlameForm = function () {
                $('#new-blame-form').addClass('hidden');
                $('#description').val('');
                $('#language').val(0);
                $('#code').val('');
            };
        });
    </script>
</body>
</html>
